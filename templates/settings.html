{% extends "base.html" %}

{% block title %}Settings - Energy Dashboard{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">Settings</h1>
    <p class="page-subtitle">Configure your Energy Dashboard</p>
</div>

<!-- Home Assistant Connection -->
<div class="main-card">
    <h2 class="main-card-title">Home Assistant Connection</h2>
    <form method="POST" style="margin-top: var(--space-4);">
        <div class="form-group">
            <label for="ha_url" class="form-label">
                Home Assistant URL
            </label>
            <input
                type="text"
                id="ha_url"
                name="ha_url"
                value="{{ config.HA_URL if config else '' }}"
                placeholder="http://homeassistant.local:8123"
                class="form-input"
            >
        </div>

        <div class="form-group">
            <label for="ha_token" class="form-label">
                Long-Lived Access Token
            </label>
            <input
                type="password"
                id="ha_token"
                name="ha_token"
                value="{{ config.HA_TOKEN if config else '' }}"
                placeholder="Enter your Home Assistant token"
                class="form-input"
            >
            <small style="display: block; margin-top: var(--space-2); color: var(--text-muted); font-size: var(--text-xs);">
                Create a token in Home Assistant: Profile → Long-Lived Access Tokens
            </small>
        </div>
    </form>
</div>

<!-- Energy Configuration -->
<div class="main-card">
    <h2 class="main-card-title">Energy Configuration</h2>
    <form id="settingsForm" method="POST" style="margin-top: var(--space-4);">
        <div class="form-group">
            <label for="electricity_rate" class="form-label">
                Electricity Rate (€/kWh)
            </label>
            <input
                type="number"
                id="electricity_rate"
                name="electricity_rate"
                value="{{ config.ELECTRICITY_RATE if config else '0.26' }}"
                step="0.01"
                min="0"
                class="form-input"
            >
        </div>

        <div class="form-group">
            <label for="currency" class="form-label">
                Currency Symbol
            </label>
            <input
                type="text"
                id="currency"
                name="currency"
                value="{{ config.CURRENCY_SYMBOL if config else '€' }}"
                maxlength="3"
                class="form-input"
            >
        </div>

        <div class="form-group">
            <label for="cache_ttl" class="form-label">
                Cache TTL (seconds)
            </label>
            <input
                type="number"
                id="cache_ttl"
                name="cache_ttl"
                value="{{ config.CACHE_TTL if config else '300' }}"
                min="60"
                max="3600"
                class="form-input"
            >
            <small style="display: block; margin-top: var(--space-2); color: var(--text-muted); font-size: var(--text-xs);">
                How long to cache data before refreshing (60-3600 seconds). Higher = faster but less fresh data.
            </small>
        </div>

        <!-- Action Buttons -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                Save Settings
            </button>
            <button type="button" class="btn btn-secondary" onclick="testConnection()">
                Test Connection
            </button>
        </div>
    </form>
</div>

<!-- Save Result Alert -->
<div id="saveResult" style="margin-top: var(--space-4); display: none;"></div>

<!-- Test Result Alert -->
<div id="testResult" style="margin-top: var(--space-4); display: none;"></div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Handle form submission
    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const saveResultDiv = document.getElementById('saveResult');
        saveResultDiv.style.display = 'block';
        saveResultDiv.innerHTML = `
            <div class="alert alert-info">
                <span class="alert-icon">⏳</span>
                <div class="alert-content">
                    <div class="alert-title">Saving settings...</div>
                </div>
            </div>
        `;

        try {
            const formData = new FormData(e.target);
            const response = await fetch('/settings', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                saveResultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <span class="alert-icon">✅</span>
                        <div class="alert-content">
                            <div class="alert-title">Settings saved!</div>
                            <div>${data.message}</div>
                        </div>
                    </div>
                `;

                // Reload page after 2 seconds to show new values
                setTimeout(() => window.location.reload(), 2000);
            } else {
                saveResultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <span class="alert-icon">❌</span>
                        <div class="alert-content">
                            <div class="alert-title">Save failed</div>
                            <div>${data.error || 'Unable to save settings'}</div>
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            saveResultDiv.innerHTML = `
                <div class="alert alert-error">
                    <span class="alert-icon">❌</span>
                    <div class="alert-content">
                        <div class="alert-title">Save failed</div>
                        <div>${error.message}</div>
                    </div>
                </div>
            `;
        }
    });

    async function testConnection() {
        const resultDiv = document.getElementById('testResult');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div class="alert alert-info">
                <span class="alert-icon">⏳</span>
                <div class="alert-content">
                    <div class="alert-title">Testing connection...</div>
                </div>
            </div>
        `;

        try {
            const response = await fetch('/api/test-connection');
            const data = await response.json();

            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <span class="alert-icon">✅</span>
                        <div class="alert-content">
                            <div class="alert-title">Connection successful!</div>
                            <div>Connected to Home Assistant</div>
                        </div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <span class="alert-icon">❌</span>
                        <div class="alert-content">
                            <div class="alert-title">Connection failed</div>
                            <div>${data.error || 'Unable to connect to Home Assistant'}</div>
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-error">
                    <span class="alert-icon">❌</span>
                    <div class="alert-content">
                        <div class="alert-title">Connection failed</div>
                        <div>${error.message}</div>
                    </div>
                </div>
            `;
        }
    }
</script>
{% endblock %}
